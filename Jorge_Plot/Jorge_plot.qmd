---
title: "Split Packed Bubble Plot"
author: "Jorge Bris Moreno"
format:
    html:
        embed-resources: true
        code-fold: true
        toc: true
        before_body: scripts.html
---

```{r, echo=FALSE, results='asis', runtime="js"}
# Calling highcharts
cat('
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
')
```

```{r, message=FALSE, warning=FALSE, eval=FALSE}
# Libraries
library(tidyverse)
library(ggplot2)
library(dplyr)
library(viridis)
library(jsonlite)

# read df
df <- read_csv("../cleaned_data/filtered_education_data.csv")

# Select the indicators
indicators <- c("Gross enrolment ratio, lower secondary, female (%)",
                "Gross enrolment ratio, post-secondary non-tertiary, female (%)",
                "Gross enrolment ratio, pre-primary, female (%)",
                "Gross enrolment ratio, primary, female (%)",
                "Gross enrolment ratio, secondary, female (%)",
                "Gross enrolment ratio, tertiary, female (%)",
                "Gross enrolment ratio, upper secondary, female (%)")

# Filter the data
data_filtered <- df %>%
  filter(`Country Name` %in% c("Arab World", "East Asia & Pacific", "Euro area", "Europe & Central Asia", "Heavily indebted poor countries (HIPC)", "Latin America & Caribbean (excluding high income)", "Middle East & North Africa", "Middle East & North Africa (excluding high income)", "OECD members", "Sub-Saharan Africa (excluding high income)")) %>%
  filter(`Indicator Name` %in% indicators)

# Rename the indicators
new_names <- c("lower secondary", "post-secondary non-tertiary", "pre-primary", 
               "primary", "secondary", "tertiary", "upper secondary")

# Create a mapping between the old and new names
names_mapping <- setNames(new_names, indicators)

# Rename the indicators
data_filtered$`Indicator Name` <- names_mapping[data_filtered$`Indicator Name`]

# Select and rename columns
data_final <- data_filtered %>%
  select(`Country Name`, `Indicator Name`, `2014`) %>%
  rename(Value = `2014`, Indicator = `Indicator Name`)

# print data
print(data_final)

# json format
df_json <- toJSON(data_final, dataframe = "columns")

# print json format to manually paste
df_json
```

```{ojs}
// Define dataset
initialData = [
  {"Country Name":"Arab World","Indicator":"lower secondary","Value":81.054},
  {"Country Name":"Arab World","Indicator":"post-secondary non-tertiary","Value":"NA"},
  {"Country Name":"Arab World","Indicator":"pre-primary","Value":25.3707},
  {"Country Name":"Arab World","Indicator":"primary","Value":93.608},
  {"Country Name":"Arab World","Indicator":"secondary","Value":67.9689},
  {"Country Name":"Arab World","Indicator":"tertiary","Value":28.768},
  {"Country Name":"Arab World","Indicator":"upper secondary","Value":54.5065},
  {"Country Name":"East Asia & Pacific","Indicator":"lower secondary","Value":96.6641},
  {"Country Name":"East Asia & Pacific","Indicator":"post-secondary non-tertiary","Value":"NA"},
  {"Country Name":"East Asia & Pacific","Indicator":"pre-primary","Value":76.0034},
  {"Country Name":"East Asia & Pacific","Indicator":"primary","Value":104.9668},
  {"Country Name":"East Asia & Pacific","Indicator":"secondary","Value":88.3206},
  {"Country Name":"East Asia & Pacific","Indicator":"tertiary","Value":41.4262},
  {"Country Name":"East Asia & Pacific","Indicator":"upper secondary","Value":79.7367},
  {"Country Name":"Euro area","Indicator":"lower secondary","Value":108.7706},
  {"Country Name":"Euro area","Indicator":"post-secondary non-tertiary","Value":"NA"},
  {"Country Name":"Euro area","Indicator":"pre-primary","Value":102.3132},
  {"Country Name":"Euro area","Indicator":"primary","Value":103.4798},
  {"Country Name":"Euro area","Indicator":"secondary","Value":110.7075},
  {"Country Name":"Euro area","Indicator":"tertiary","Value":76.299},
  {"Country Name":"Euro area","Indicator":"upper secondary","Value":112.9169},
  {"Country Name":"Europe & Central Asia","Indicator":"lower secondary","Value":103.7713},
  {"Country Name":"Europe & Central Asia","Indicator":"post-secondary non-tertiary","Value":"NA"},
  {"Country Name":"Europe & Central Asia","Indicator":"pre-primary","Value":74.2163},
  {"Country Name":"Europe & Central Asia","Indicator":"primary","Value":103.1583},
  {"Country Name":"Europe & Central Asia","Indicator":"secondary","Value":105.389},
  {"Country Name":"Europe & Central Asia","Indicator":"tertiary","Value":69.8713},
  {"Country Name":"Europe & Central Asia","Indicator":"upper secondary","Value":107.4027},
  {"Country Name":"Heavily indebted poor countries (HIPC)","Indicator":"lower secondary","Value":"NA"},
  {"Country Name":"Heavily indebted poor countries (HIPC)","Indicator":"post-secondary non-tertiary","Value":18.0427},
  {"Country Name":"Heavily indebted poor countries (HIPC)","Indicator":"pre-primary","Value":98.0805},
  {"Country Name":"Heavily indebted poor countries (HIPC)","Indicator":"primary","Value":35.621},
  {"Country Name":"Heavily indebted poor countries (HIPC)","Indicator":"secondary","Value":6.233},
  {"Country Name":"Heavily indebted poor countries (HIPC)","Indicator":"tertiary","Value":24.4659},
  {"Country Name":"Heavily indebted poor countries (HIPC)","Indicator":"upper secondary","Value":108.0586},
  {"Country Name":"Latin America & Caribbean (excluding high income)","Indicator":"lower secondary","Value":"NA"},
  {"Country Name":"Latin America & Caribbean(excluding high income)","Indicator":"post-secondary non-tertiary","Value":72.4493},
  {"Country Name":"Latin America & Caribbean (excluding high income)","Indicator":"pre-primary","Value":107.3809},
  {"Country Name":"Latin America & Caribbean (excluding high income)","Indicator":"primary","Value":97.1722},
  {"Country Name":"Latin America & Caribbean (excluding high income)","Indicator":"secondary","Value":48.967},
  {"Country Name":"Latin America & Caribbean (excluding high income)","Indicator":"tertiary","Value":84.4792},
  {"Country Name":"Latin America & Caribbean (excluding high income)","Indicator":"upper secondary","Value":88.4424},
  {"Country Name":"Middle East & North Africa","Indicator":"lower secondary","Value":"NA"},
  {"Country Name":"Middle East & North Africa","Indicator":"post-secondary non-tertiary","Value":29.5462},
  {"Country Name":"Middle East & North Africa","Indicator":"pre-primary","Value":103.047},
  {"Country Name":"Middle East & North Africa","Indicator":"primary","Value":76.9069},
  {"Country Name":"Middle East & North Africa","Indicator":"secondary","Value":38.2514},
  {"Country Name":"Middle East & North Africa","Indicator":"tertiary","Value":65.6759},
  {"Country Name":"Middle East & North Africa","Indicator":"upper secondary","Value":86.992},
  {"Country Name":"Middle East & North Africa (excluding high income)","Indicator":"lower secondary","Value":"NA"},
  {"Country Name":"Middle East & North Africa (excluding high income)","Indicator":"post-secondary non-tertiary","Value":26.8679},
  {"Country Name":"Middle East & North Africa (excluding high income)","Indicator":"pre-primary","Value":102.4904},
  {"Country Name":"Middle East & North Africa (excluding high income)","Indicator":"primary","Value":74.3971},
  {"Country Name":"Middle East & North Africa (excluding high income)","Indicator":"secondary","Value":36.1012},
  {"Country Name":"Middle East & North Africa (excluding high income)","Indicator":"tertiary","Value":62.3747},
  {"Country Name":"Middle East & North Africa (excluding high income)","Indicator":"upper secondary","Value":107.3207},
  {"Country Name":"OECD members","Indicator":"lower secondary","Value":79.3329},
  {"Country Name":"OECD members","Indicator":"post-secondary non-tertiary","Value":"NA"},
  {"Country Name":"OECD members","Indicator":"pre-primary","Value":102.2592},
  {"Country Name":"OECD members","Indicator":"primary","Value":104.3177},
  {"Country Name":"OECD members","Indicator":"secondary","Value":75.5335},
  {"Country Name":"OECD members","Indicator":"tertiary","Value":101.3419},
  {"Country Name":"OECD members","Indicator":"upper secondary","Value":46.1386},
  {"Country Name":"Sub-Saharan Africa (excluding high income)","Indicator":"lower secondary","Value":"NA"},
  {"Country Name":"Sub-Saharan Africa (excluding high income)","Indicator":"post-secondary non-tertiary","Value":22.0271},
  {"Country Name":"Sub-Saharan Africa (excluding high income)","Indicator":"pre-primary","Value":94.7689},
  {"Country Name":"Sub-Saharan Africa (excluding high income)","Indicator":"primary","Value":39.5373},
  {"Country Name":"Sub-Saharan Africa (excluding high income)","Indicator":"secondary","Value":7.2426},
  {"Country Name":"Sub-Saharan Africa (excluding high income)","Indicator":"tertiary","Value":31.7493},
  {"Country Name":"Sub-Saharan Africa (excluding high income)","Indicator":"upper secondary","Value":108.0586}
];

// Filter and parse the dataset
parsedData = initialData.filter(d => d.Value !== "NA").map(d => ({
  ...d,
  Value: parseFloat(d.Value)
}));

// Group by "Country Name" and accumulate indicators and values
seriesData = parsedData.reduce((acc, { "Country Name": countryName, Indicator, Value }) => {
  let group = acc.find(g => g.name === countryName);
  if (!group) {
    group = { name: countryName, data: [] };
    acc.push(group);
  }
  group.data.push({ name: Indicator, value: Value });
  return acc;
}, []);
```

<figure>
  <div id="container"></div>
  <figcaption>This chart shows the Female Gross Enrollment Ratios by Region for the year 2014. These region delimitations have been chosen from what global organizations like the World Bank utilize for their studies. You can select and deselect regions to focus on different regions, each bubble inside the region represents an education level, and the values inside are the female gross enrollment ration for 2014. The sizes of the bubbles correlate to the values. If levels of education are not present in a region is due to the lack of information about that specific combination of education level and region.</figcaption>
</figure>

```{ojs, message=FALSE, warning=FALSE, echo = FALSE, return = FALSE}
// Highcharts plotting
function renderChart() {
    Highcharts.chart('container', {
        chart: {
            type: 'packedbubble',
            height: '100%'
        },
        title: {
            text: 'Female Gross Enrollment Ratios by Region (2014)'
        },
        tooltip: {
            useHTML: true,
            pointFormat: '<b>{point.name}:</b> {point.value}%'
        },
        plotOptions: {
            packedbubble: {
                minSize: '10%',
                maxSize: '100%',
                zMin: 0,
                zMax: 400,
                layoutAlgorithm: {
                    gravitationalConstant: 0.05,
                    splitSeries: true,
                    seriesInteraction: false,
                    dragBetweenSeries: true,
                    parentNodeLimit: true
                },
                dataLabels: {
                    enabled: true,
                    format: '{point.name}',
                    style: {
                        color: 'black',
                        textOutline: 'none',
                        fontWeight: 'normal'
                    }
                }
            }
        },
        series: seriesData
    })};
// Render the chart
renderChart();
```